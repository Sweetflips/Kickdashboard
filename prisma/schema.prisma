generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                           BigInt                @id @default(autoincrement())
  kick_user_id                 BigInt                @unique
  username                     String
  email                        String?
  profile_picture_url          String?
  access_token_hash            String?
  refresh_token_hash           String?
  last_login_at                DateTime?
  created_at                   DateTime              @default(now())
  updated_at                   DateTime              @updatedAt
  custom_profile_picture_url   String?
  notifications_enabled        Boolean               @default(true)
  email_notifications_enabled  Boolean               @default(false)
  chat_font_size               String?               @default("14px")
  chat_show_timestamps         Boolean               @default(true)
  discord_user_id              String?
  discord_username             String?
  discord_access_token_hash    String?
  discord_connected            Boolean               @default(false)
  telegram_user_id             String?
  telegram_username            String?
  telegram_access_token_hash   String?
  telegram_connected           Boolean               @default(false)
  kick_connected               Boolean               @default(true)
  is_admin                     Boolean               @default(false)
  access_token_encrypted       String?
  refresh_token_encrypted      String?
  last_ip_address              String?
  last_user_agent              String?
  email_verified_at            DateTime?
  bio                          String?
  signup_ip_address            String?
  signup_user_agent            String?
  signup_referrer              String?
  instagram_url                String?
  twitter_url                  String?
  broadcaster_messages         ChatMessage[]         @relation("BroadcasterMessages")
  sent_messages                ChatMessage[]         @relation("SenderMessages")
  offline_broadcaster_messages OfflineChatMessage[]  @relation("OfflineBroadcasterMessages")
  offline_sent_messages        OfflineChatMessage[]  @relation("OfflineSenderMessages")
  point_history                PointHistory[]
  promo_code_redemptions       PromoCodeRedemption[] @relation("PromoCodeRedemptions")
  promo_codes_created          PromoCode[]           @relation("PromoCodeCreator")
  raffle_entries               RaffleEntry[]
  raffles_created              Raffle[]
  referral_rewards_earned      ReferralReward[]
  referrals_as_referee         Referral?             @relation("Referee")
  referrals_as_referrer        Referral[]            @relation("Referrer")
  stream_sessions              StreamSession[]
  points                       UserPoints?
  user_sessions                UserSession[]

  @@map("users")
}

model StreamSession {
  id                          BigInt         @id @default(autoincrement())
  broadcaster_user_id         BigInt
  channel_slug                String
  session_title               String?
  started_at                  DateTime       @default(now())
  ended_at                    DateTime?
  peak_viewer_count           Int            @default(0)
  total_messages              Int            @default(0)
  created_at                  DateTime       @default(now())
  updated_at                  DateTime       @updatedAt
  thumbnail_url               String?
  duration_seconds            Int?
  thumbnail_captured_at       DateTime?
  thumbnail_last_refreshed_at DateTime?
  thumbnail_source            String?
  kick_stream_id              String?
  kick_video_id                String?
  chat_messages               ChatMessage[]
  point_history               PointHistory[]
  broadcaster                 User           @relation(fields: [broadcaster_user_id], references: [kick_user_id])

  @@map("stream_sessions")
}

model ChatMessage {
  id                    BigInt         @id @default(autoincrement())
  message_id            String         @unique
  stream_session_id     BigInt?
  sender_user_id        BigInt
  sender_username       String
  broadcaster_user_id   BigInt
  content               String
  emotes                Json?
  timestamp             BigInt
  created_at            DateTime       @default(now())
  sender_username_color String?
  sender_badges         Json?
  sender_is_verified    Boolean        @default(false)
  sender_is_anonymous   Boolean        @default(false)
  points_earned         Int            @default(0)
  sent_when_offline     Boolean        @default(false)
  points_reason         String?
  broadcaster           User           @relation("BroadcasterMessages", fields: [broadcaster_user_id], references: [kick_user_id])
  sender                User           @relation("SenderMessages", fields: [sender_user_id], references: [kick_user_id])
  stream_session        StreamSession? @relation(fields: [stream_session_id], references: [id])

  @@index([broadcaster_user_id, timestamp])
  @@index([stream_session_id, timestamp])
  @@map("chat_messages")
}

model OfflineChatMessage {
  id                    BigInt   @id @default(autoincrement())
  message_id            String   @unique
  sender_user_id        BigInt
  sender_username       String
  broadcaster_user_id   BigInt
  content               String
  emotes                Json?
  timestamp             BigInt
  sender_username_color String?
  sender_badges         Json?
  sender_is_verified    Boolean  @default(false)
  sender_is_anonymous   Boolean  @default(false)
  created_at            DateTime @default(now())
  broadcaster           User     @relation("OfflineBroadcasterMessages", fields: [broadcaster_user_id], references: [kick_user_id])
  sender                User     @relation("OfflineSenderMessages", fields: [sender_user_id], references: [kick_user_id])

  @@index([broadcaster_user_id, timestamp])
  @@map("offline_chat_messages")
}

model UserPoints {
  id                   BigInt    @id @default(autoincrement())
  user_id              BigInt    @unique
  total_points         Int       @default(0)
  last_point_earned_at DateTime?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt
  total_emotes         Int       @default(0)
  is_subscriber        Boolean   @default(false)
  user                 User      @relation(fields: [user_id], references: [id])

  @@map("user_points")
}

model PointHistory {
  id                BigInt         @id @default(autoincrement())
  user_id           BigInt
  stream_session_id BigInt?
  points_earned     Int            @default(1)
  message_id        String?
  earned_at         DateTime       @default(now())
  created_at        DateTime       @default(now())
  stream_session    StreamSession? @relation(fields: [stream_session_id], references: [id])
  user              User           @relation(fields: [user_id], references: [id])

  @@map("point_history")
}

model Raffle {
  id                   BigInt               @id @default(autoincrement())
  title                String
  description          String?
  type                 String               @default("general")
  prize_description    String
  ticket_cost          Int
  max_tickets_per_user Int?
  total_tickets_cap    Int?
  start_at             DateTime
  end_at               DateTime
  status               String               @default("upcoming")
  sub_only             Boolean              @default(false)
  hidden_until_start   Boolean              @default(false)
  draw_seed            String?
  drawn_at             DateTime?
  created_by           BigInt
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt
  claim_message        String?
  hidden               Boolean              @default(false)
  number_of_winners    Int                  @default(1)
  rigging_enabled      Boolean              @default(false)
  center_logo_url      String?
  slice_opacity        Float?               @default(0.5)
  wheel_background_url String?
  entries              RaffleEntry[]
  rigged_winners       RaffleRiggedWinner[]
  winners              RaffleWinner[]
  creator              User                 @relation(fields: [created_by], references: [id])

  @@map("raffles")
}

model RaffleEntry {
  id          BigInt               @id @default(autoincrement())
  raffle_id   BigInt
  user_id     BigInt
  tickets     Int                  @default(1)
  created_at  DateTime             @default(now())
  source      String               @default("system")
  raffle      Raffle               @relation(fields: [raffle_id], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [user_id], references: [id])
  riggedSlots RaffleRiggedWinner[]
  wins        RaffleWinner[]

  @@unique([raffle_id, user_id])
  @@map("raffle_entries")
}

model RaffleWinner {
  id                    BigInt      @id @default(autoincrement())
  raffle_id             BigInt
  entry_id              BigInt
  selected_at           DateTime    @default(now())
  is_rigged             Boolean?    @default(false)
  selected_ticket_index BigInt?
  spin_number           Int?
  entry                 RaffleEntry @relation(fields: [entry_id], references: [id], onDelete: Cascade)
  raffle                Raffle      @relation(fields: [raffle_id], references: [id], onDelete: Cascade)

  @@map("raffle_winners")
}

model RaffleRiggedWinner {
  id        BigInt      @id @default(autoincrement())
  raffle_id BigInt
  entry_id  BigInt
  position  Int
  entry     RaffleEntry @relation(fields: [entry_id], references: [id], onDelete: Cascade)
  raffle    Raffle      @relation(fields: [raffle_id], references: [id], onDelete: Cascade)

  @@unique([raffle_id, position])
  @@map("raffle_rigged_winners")
}

model UserSession {
  id           BigInt   @id @default(autoincrement())
  user_id      BigInt
  session_id   String   @unique
  region       String?
  country      String?
  client_type  String?
  user_agent   String?
  ip_hash      String?
  created_at   DateTime @default(now())
  last_seen_at DateTime @default(now())
  updated_at   DateTime @updatedAt
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([last_seen_at])
  @@map("user_sessions")
}

model PromoCode {
  id           BigInt                @id @default(autoincrement())
  code         String                @unique
  points_value Int
  max_uses     Int?
  current_uses Int                   @default(0)
  expires_at   DateTime?
  is_active    Boolean               @default(true)
  created_by   BigInt
  created_at   DateTime              @default(now())
  updated_at   DateTime              @updatedAt
  redemptions  PromoCodeRedemption[]
  creator      User                  @relation("PromoCodeCreator", fields: [created_by], references: [id])

  @@index([code])
  @@index([expires_at])
  @@index([is_active])
  @@map("promo_codes")
}

model PromoCodeRedemption {
  id             BigInt    @id @default(autoincrement())
  promo_code_id  BigInt
  user_id        BigInt
  points_awarded Int
  redeemed_at    DateTime  @default(now())
  promo_code     PromoCode @relation(fields: [promo_code_id], references: [id], onDelete: Cascade)
  user           User      @relation("PromoCodeRedemptions", fields: [user_id], references: [id])

  @@unique([promo_code_id, user_id])
  @@index([user_id])
  @@index([redeemed_at])
  @@map("promo_code_redemptions")
}

model PointAwardJob {
  id                BigInt    @id @default(autoincrement())
  kick_user_id      BigInt
  stream_session_id BigInt?
  message_id        String    @unique
  badges            Json?
  emotes            Json?
  status            String    @default("pending")
  attempts          Int       @default(0)
  locked_at         DateTime?
  processed_at      DateTime?
  last_error        String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  @@index([status, created_at])
  @@index([status, locked_at])
  @@map("point_award_jobs")
}

model ChatJob {
  id                  BigInt    @id @default(autoincrement())
  message_id          String    @unique
  payload             Json
  sender_user_id      BigInt
  broadcaster_user_id BigInt
  stream_session_id   BigInt?
  status              String    @default("pending")
  attempts            Int       @default(0)
  locked_at           DateTime?
  processed_at        DateTime?
  last_error          String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  @@index([status, created_at])
  @@index([status, locked_at])
  @@map("chat_jobs")
}

model AdventPurchase {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  item_id    String
  tickets    Int      @default(1)
  created_at DateTime @default(now())

  @@unique([user_id, item_id])
  @@map("advent_purchases")
}

model AdventDayStatus {
  day        Int       @id
  drawn      Boolean   @default(false)
  drawn_at   DateTime?
  drawn_by   BigInt?
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  @@map("advent_day_status")
}

model Referral {
  id               BigInt   @id @default(autoincrement())
  referrer_user_id BigInt
  referee_user_id  BigInt   @unique
  referral_code    String
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  referee          User     @relation("Referee", fields: [referee_user_id], references: [id], onDelete: Cascade)
  referrer         User     @relation("Referrer", fields: [referrer_user_id], references: [id], onDelete: Cascade)

  @@index([referrer_user_id])
  @@index([referral_code])
  @@index([created_at])
  @@map("referrals")
}

model ReferralReward {
  id               BigInt   @id @default(autoincrement())
  referrer_user_id BigInt
  referee_user_id  BigInt
  tier_id          String
  required_points  Int
  reward_points    Int
  awarded_at       DateTime @default(now())
  created_at       DateTime @default(now())
  referrer_user    User     @relation(fields: [referrer_user_id], references: [id], onDelete: Cascade)

  @@unique([referrer_user_id, referee_user_id, tier_id])
  @@index([referrer_user_id])
  @@index([awarded_at])
  @@map("referral_rewards")
}
